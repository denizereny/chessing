<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property 12: Keyboard Navigation Test</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive-settings-menu.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .info-section {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .controls {
            padding: 30px;
            text-align: center;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            padding: 20px 30px;
            font-size: 1.1em;
            font-weight: 600;
            text-align: center;
        }

        .status.ready { background: #d4edda; color: #155724; }
        .status.running { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }

        .output {
            padding: 30px;
            background: #f8f9fa;
            max-height: 600px;
            overflow-y: auto;
        }

        .output pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .stat-card .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card.total .stat-value { color: #667eea; }
        .stat-card.passed .stat-value { color: #28a745; }
        .stat-card.failed .stat-value { color: #dc3545; }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>‚å®Ô∏è Property 12: Keyboard Navigation</h1>
            <p>Property-Based Tests - Task 9.5</p>
        </div>

        <div class="info-section">
            <h3>üìã Test Information</h3>
            <p><strong>Feature:</strong> responsive-settings-menu</p>
            <p><strong>Task:</strong> 9.5 Write property test for keyboard navigation</p>
            <p><strong>Property:</strong> Property 12: Keyboard navigation</p>
            <p><strong>Validates:</strong> Requirements 6.2</p>
            <p><strong>Description:</strong> For any keyboard input (Tab, Enter, Escape), the settings menu should respond appropriately</p>
        </div>

        <div class="stats">
            <div class="stat-card total">
                <div class="stat-value" id="totalTests">0</div>
                <div class="stat-label">Total Tests</div>
            </div>
            <div class="stat-card passed">
                <div class="stat-value" id="passedTests">0</div>
                <div class="stat-label">Passed</div>
            </div>
            <div class="stat-card failed">
                <div class="stat-value" id="failedTests">0</div>
                <div class="stat-label">Failed</div>
            </div>
        </div>

        <div class="status ready" id="status">
            ‚úÖ Ready to run tests
        </div>

        <div class="controls">
            <button class="btn" onclick="runPropertyTests()">‚ñ∂Ô∏è Run Property Tests</button>
            <button class="btn" onclick="testManually()">üß™ Manual Test</button>
        </div>

        <div class="output" id="output" style="display: none;">
            <pre id="outputContent"></pre>
        </div>
    </div>

    <!-- Settings Menu (from index.html) -->
    <button 
      id="settingsMenuToggle" 
      class="settings-menu-toggle"
      aria-label="Open settings menu"
      aria-expanded="false"
      aria-controls="settingsMenuPanel"
      type="button">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="5" r="2" fill="currentColor"/>
        <circle cx="12" cy="12" r="2" fill="currentColor"/>
        <circle cx="12" cy="19" r="2" fill="currentColor"/>
      </svg>
    </button>

    <div id="settingsMenuBackdrop" class="settings-menu-backdrop"></div>

    <aside id="settingsMenuPanel" class="settings-menu-panel" role="dialog" aria-modal="true" aria-hidden="true">
      <div id="settingsMenuAnnouncer" class="visually-hidden" role="status" aria-live="polite"></div>
      
      <div class="settings-menu-header">
        <h2 id="settingsMenuTitle" class="settings-menu-title">Settings</h2>
        <button id="settingsMenuClose" class="settings-menu-close" aria-label="Close settings menu" type="button">‚úñ</button>
      </div>
      
      <div class="settings-menu-content">
        <div class="menu-control-group">
          <button class="extra-btn menu-control-btn" id="btnTheme">üåô Dark Mode</button>
        </div>
        <div class="menu-control-group">
          <select id="languageSelect" class="menu-control-select">
            <option value="en">English</option>
            <option value="tr">T√ºrk√ße</option>
          </select>
        </div>
        <div class="menu-control-group">
          <button class="extra-btn menu-control-btn" id="btnPieceSetup">‚ôî Piece Setup</button>
        </div>
      </div>
    </aside>

    <!-- Load fast-check -->
    <script src="https://cdn.jsdelivr.net/npm/fast-check@3.15.0/lib/bundle.js"></script>
    
    <!-- Load settings menu manager -->
    <script src="js/settings-menu-manager.js"></script>

    <script>
        let testStats = { total: 0, passed: 0, failed: 0 };
        let settingsMenuManager;

        // Initialize settings menu
        document.addEventListener('DOMContentLoaded', function() {
            settingsMenuManager = new SettingsMenuManager();
            settingsMenuManager.initialize();
            window.settingsMenuManager = settingsMenuManager;
        });

        function updateStatus(message, type = 'ready') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function appendOutput(text) {
            const outputContent = document.getElementById('outputContent');
            outputContent.textContent += text + '\n';
            document.getElementById('output').scrollTop = document.getElementById('output').scrollHeight;
        }

        function updateStats() {
            document.getElementById('totalTests').textContent = testStats.total;
            document.getElementById('passedTests').textContent = testStats.passed;
            document.getElementById('failedTests').textContent = testStats.failed;
        }

        function testManually() {
            alert('Manual Test:\n\n1. Click the settings menu toggle button (3 dots)\n2. Press Tab to navigate between controls\n3. Press Enter to activate a control\n4. Press Escape to close the menu\n\nVerify that all keyboard interactions work correctly.');
            
            if (settingsMenuManager) {
                settingsMenuManager.open();
            }
        }

        async function runPropertyTests() {
            testStats = { total: 0, passed: 0, failed: 0 };
            updateStats();
            
            document.getElementById('output').style.display = 'block';
            document.getElementById('outputContent').textContent = '';
            
            updateStatus('üîÑ Running property tests...', 'running');
            appendOutput('‚å®Ô∏è Property 12: Keyboard Navigation Tests');
            appendOutput('='.repeat(60));
            appendOutput('');

            if (!fc) {
                updateStatus('‚ùå fast-check not loaded', 'error');
                appendOutput('‚ùå Error: fast-check library not available');
                return;
            }

            try {
                // Helper functions
                function simulateKeyboardEvent(key, shiftKey = false) {
                    return new KeyboardEvent('keydown', {
                        key: key,
                        keyCode: key === 'Tab' ? 9 : key === 'Enter' ? 13 : key === 'Escape' ? 27 : 0,
                        shiftKey: shiftKey,
                        bubbles: true,
                        cancelable: true
                    });
                }

                function isMenuOpen() {
                    const backdrop = document.querySelector('#settingsMenuBackdrop');
                    return backdrop && backdrop.classList.contains('active');
                }

                function getFocusableElements() {
                    const menu = document.querySelector('#settingsMenuPanel');
                    if (!menu) return [];
                    
                    const selectors = 'a[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex="-1"])';
                    return Array.from(menu.querySelectorAll(selectors)).filter(el => {
                        const style = window.getComputedStyle(el);
                        return style.display !== 'none' && style.visibility !== 'hidden' && el.offsetParent !== null;
                    });
                }

                // Test 1: Escape key closes menu
                appendOutput('Test 1: Escape key should close the menu');
                testStats.total++;
                
                try {
                    let passed = true;
                    
                    for (let i = 0; i < 10; i++) {
                        // Open menu
                        if (!isMenuOpen()) {
                            settingsMenuManager.open();
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                        
                        if (!isMenuOpen()) {
                            passed = false;
                            appendOutput(`  ‚ùå Failed to open menu on iteration ${i + 1}`);
                            break;
                        }
                        
                        // Press Escape
                        const event = simulateKeyboardEvent('Escape');
                        document.dispatchEvent(event);
                        await new Promise(resolve => setTimeout(resolve, 350));
                        
                        if (isMenuOpen()) {
                            passed = false;
                            appendOutput(`  ‚ùå Menu did not close on iteration ${i + 1}`);
                            break;
                        }
                    }
                    
                    if (passed) {
                        testStats.passed++;
                        appendOutput('  ‚úÖ PASSED - Escape key closes menu (10 iterations)');
                    } else {
                        testStats.failed++;
                    }
                } catch (error) {
                    testStats.failed++;
                    appendOutput(`  ‚ùå ERROR: ${error.message}`);
                }
                appendOutput('');

                // Test 2: Tab navigation within menu
                appendOutput('Test 2: Tab key should navigate between focusable elements');
                testStats.total++;
                
                try {
                    // Open menu
                    if (!isMenuOpen()) {
                        settingsMenuManager.open();
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    const focusableElements = getFocusableElements();
                    
                    if (focusableElements.length === 0) {
                        testStats.passed++;
                        appendOutput('  ‚úÖ PASSED - No focusable elements (test not applicable)');
                    } else {
                        appendOutput(`  Found ${focusableElements.length} focusable elements`);
                        
                        // Focus first element
                        focusableElements[0].focus();
                        await new Promise(resolve => setTimeout(resolve, 50));
                        
                        // Press Tab a few times
                        for (let i = 0; i < Math.min(5, focusableElements.length); i++) {
                            const event = simulateKeyboardEvent('Tab');
                            document.dispatchEvent(event);
                            await new Promise(resolve => setTimeout(resolve, 50));
                            
                            // Check focus is still within menu
                            const activeElement = document.activeElement;
                            if (!focusableElements.includes(activeElement)) {
                                testStats.failed++;
                                appendOutput(`  ‚ùå FAILED - Focus escaped menu after ${i + 1} Tab presses`);
                                settingsMenuManager.close();
                                throw new Error('Focus escaped menu');
                            }
                        }
                        
                        testStats.passed++;
                        appendOutput('  ‚úÖ PASSED - Tab navigation stays within menu');
                    }
                    
                    settingsMenuManager.close();
                    await new Promise(resolve => setTimeout(resolve, 350));
                } catch (error) {
                    if (testStats.failed === testStats.total - 1) {
                        // Already marked as failed
                    } else {
                        testStats.failed++;
                        appendOutput(`  ‚ùå ERROR: ${error.message}`);
                    }
                }
                appendOutput('');

                // Test 3: Shift+Tab backwards navigation
                appendOutput('Test 3: Shift+Tab should navigate backwards');
                testStats.total++;
                
                try {
                    // Open menu
                    if (!isMenuOpen()) {
                        settingsMenuManager.open();
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    const focusableElements = getFocusableElements();
                    
                    if (focusableElements.length < 2) {
                        testStats.passed++;
                        appendOutput('  ‚úÖ PASSED - Not enough elements for backwards navigation test');
                    } else {
                        // Focus last element
                        const lastElement = focusableElements[focusableElements.length - 1];
                        lastElement.focus();
                        await new Promise(resolve => setTimeout(resolve, 50));
                        
                        // Press Shift+Tab
                        const event = simulateKeyboardEvent('Tab', true);
                        document.dispatchEvent(event);
                        await new Promise(resolve => setTimeout(resolve, 50));
                        
                        // Check focus is still within menu
                        const activeElement = document.activeElement;
                        if (focusableElements.includes(activeElement)) {
                            testStats.passed++;
                            appendOutput('  ‚úÖ PASSED - Shift+Tab navigation stays within menu');
                        } else {
                            testStats.failed++;
                            appendOutput('  ‚ùå FAILED - Focus escaped menu with Shift+Tab');
                        }
                    }
                    
                    settingsMenuManager.close();
                    await new Promise(resolve => setTimeout(resolve, 350));
                } catch (error) {
                    testStats.failed++;
                    appendOutput(`  ‚ùå ERROR: ${error.message}`);
                }
                appendOutput('');

                // Test 4: Keyboard navigation at different viewport sizes
                appendOutput('Test 4: Keyboard navigation should work at any viewport size');
                testStats.total++;
                
                try {
                    const viewportSizes = [
                        { width: 375, height: 667 },   // Mobile
                        { width: 768, height: 1024 },  // Tablet
                        { width: 1920, height: 1080 }  // Desktop
                    ];
                    
                    let allPassed = true;
                    
                    for (const size of viewportSizes) {
                        // Note: Can't actually resize window in test, but we can verify menu works
                        
                        // Open menu
                        if (!isMenuOpen()) {
                            settingsMenuManager.open();
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                        
                        // Press Escape
                        const event = simulateKeyboardEvent('Escape');
                        document.dispatchEvent(event);
                        await new Promise(resolve => setTimeout(resolve, 350));
                        
                        if (isMenuOpen()) {
                            allPassed = false;
                            appendOutput(`  ‚ùå Failed at viewport ${size.width}x${size.height}`);
                            break;
                        }
                    }
                    
                    if (allPassed) {
                        testStats.passed++;
                        appendOutput('  ‚úÖ PASSED - Keyboard navigation works across viewport sizes');
                    } else {
                        testStats.failed++;
                    }
                } catch (error) {
                    testStats.failed++;
                    appendOutput(`  ‚ùå ERROR: ${error.message}`);
                }
                appendOutput('');

                // Summary
                appendOutput('='.repeat(60));
                appendOutput('üìä Test Summary:');
                appendOutput(`Total Tests: ${testStats.total}`);
                appendOutput(`Passed: ${testStats.passed}`);
                appendOutput(`Failed: ${testStats.failed}`);
                appendOutput('');

                updateStats();

                if (testStats.failed === 0) {
                    updateStatus(`‚úÖ All tests passed! (${testStats.passed}/${testStats.total})`, 'success');
                    appendOutput('‚úÖ All property-based tests completed successfully!');
                } else {
                    updateStatus(`‚ùå Some tests failed (${testStats.failed}/${testStats.total})`, 'error');
                    appendOutput('‚ùå Some tests failed. Please review the results above.');
                }

            } catch (error) {
                updateStatus('‚ùå Test execution error', 'error');
                appendOutput(`‚ùå Fatal error: ${error.message}`);
                console.error('Test execution error:', error);
            }
        }
    </script>
</body>
</html>
